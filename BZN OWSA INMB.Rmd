---
title: "BZN OWA"
author: "Philip Wikman"
date: "2025-01-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Paquetes necesarios
library(dplyr)
library(ggplot2)
library(MASS)
library(tidyr)
library(ggplot2)
source("calculate_qalys_costs.R")
source("Simulate.R")
source("Simulate_t.R")
source("QalyCost.R")
```


```{r}
# Definir parámetros del modelo
cycle_length <- 1        # Longitud de cada ciclo (en años)
discount_rate <- 0.03    # Tasa de descuento anual
BestVariab<-as.numeric(as.vector(readRDS("BestVariab_100000.RDS")))
grupos_sexo<-c("Hombre", "Mujer")
states <- c("Chronic_Asymptomatic", "Cardiac", "Digestive", "Death")
grupos_edad<-c("15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", "60-64", "65-69")
# Estados de salud

P_card<-BestVariab[1]
CaMorR<-BestVariab[2]
DiMorR<-BestVariab[3] # Cucunubá et al. Parasites&Vectors 2016
P_card_t<-BestVariab[1]*0.54
P_dig<-BestVariab[4]
P_dig_t<-BestVariab[4]*0.90

P_mort_m<-c(0.00015, 0.00037, 0.00044, 0.00054, 0.00077, 0.00095, 0.00161, 0.00289, 0.00543, 0.00893, 0.01401)
P_mort_W<-c(0.00014, 0.00016, 0.00015, 0.00023, 0.00037, 0.00062, 0.00096, 0.00158, 0.00273, 0.00429, 0.00648)

qaly_weights <- c(
  Chronic_Asymptomatic = 0.9625,
  Cardiac = 0.7171,
  Digestive = 0.80,
  Death = 0
)

costs <- c(
  Chronic_Asymptomatic = 380.26,
  Cardiac = 11592.27,
  Digestive = 554.56,
  Death = 0
)
discount_rate <- 0.03  # 3% discount rate

OWSADAT<-data.frame(matrix(NA, nrow=6, ncol=3))
colnames(OWSADAT)<-c("Parameter", "ICER_high", "ICER_low")
```

# 1. Probability of developing Chagas sympthomatic cardiomyopathy (P_card)

## High value
### Simulating non-treatment arm
```{r}
population_over_time<-Simulate(P_card=0.03, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=P_dig, horizon=20)
```

### Simulating the treatment arm

```{r}
population_over_time_t<-Simulate_t(P_card=0.03, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=P_dig, RR_T_car=0.54, RR_T_dig=0.90, horizon=20)
```

# Calculate Qalys and costs 

```{r}
Det_CEA_H_1<-QalyCost(population_over_time, population_over_time_t)


Det_CEA_H_1
```
## low value
```{r}
population_over_time<-Simulate(P_card=0.01, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=P_dig, horizon=20)
```

```{r}
population_over_time_t<-Simulate_t(P_card=0.01, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=P_dig, RR_T_car=0.54, RR_T_dig=0.90, horizon=20)
```
 
```{r}
Det_CEA_L_1<-QalyCost(population_over_time, population_over_time_t)
Det_CEA_L_1
```

```{r}
OWSADAT[1,]<-c("P_card", Det_CEA_H_1$ICER[2], Det_CEA_L_1$ICER[2])
OWSADAT
```

# 2. Chagas Cardiac Disease Mortality  (CaMorR)
```{r}
P_card<-BestVariab[1]
CaMorR<-BestVariab[2]
DiMorR<-BestVariab[3] 
P_card_t<-BestVariab[1]*0.54
P_dig<-BestVariab[4]
P_dig_t<-BestVariab[4]*0.90
```
## High value
### Simulating non-treatment arm
```{r}
population_over_time<-Simulate(P_card=P_card, CaMorR=5, DiMorR=DiMorR, P_dig=P_dig, horizon=20)
```

### Simulating the treatment arm

```{r}
population_over_time_t<-Simulate_t(P_card=P_card, CaMorR=5, DiMorR=DiMorR, P_dig=P_dig, RR_T_car=0.54, RR_T_dig=0.90, horizon=20)
```

# Calculate Qalys and costs 

```{r}
Det_CEA_H_2<-QalyCost(population_over_time, population_over_time_t)
Det_CEA_H_2
```
## low value
```{r}
population_over_time<-Simulate(P_card=P_card, CaMorR=1.1, DiMorR=DiMorR, P_dig=P_dig, horizon=20)
```

```{r}
population_over_time_t<-Simulate_t(P_card=P_card, CaMorR=1.1, DiMorR=DiMorR, P_dig=P_dig, RR_T_car=0.54, RR_T_dig=0.90, horizon=20)
```
 
```{r}
Det_CEA_L_2<-QalyCost(population_over_time, population_over_time_t)
Det_CEA_L_2
```

```{r}
OWSADAT[2,]<-c("CaMorR", Det_CEA_H_2$ICER[2], Det_CEA_L_2$ICER[2])
OWSADAT
```

# 3. Chagas Digestive disease Mortality  (DiMorR)
```{r}
P_card<-BestVariab[1]
CaMorR<-BestVariab[2]
DiMorR<-BestVariab[3] # Cucunubá et al. Parasites&Vectors 2016
P_card_t<-BestVariab[1]*0.54
P_dig<-BestVariab[4]
P_dig_t<-BestVariab[4]*0.90
```
## High value
### Simulating non-treatment arm
```{r}
population_over_time<-Simulate(P_card=P_card, CaMorR=CaMorR, DiMorR=2.5, P_dig=P_dig, horizon=20)
```

### Simulating the treatment arm

```{r}
population_over_time_t<-Simulate_t(P_card=P_card, CaMorR=CaMorR, DiMorR=2.5, P_dig=P_dig, RR_T_car=0.54, RR_T_dig=0.90, horizon=20)
```

# Calculate Qalys and costs 

```{r}
Det_CEA_H_3<-QalyCost(population_over_time, population_over_time_t)
Det_CEA_H_3
```
## low value
```{r}
population_over_time<-Simulate(P_card=P_card, CaMorR=CaMorR, DiMorR=1, P_dig=P_dig, horizon=20)
```

```{r}
population_over_time_t<-Simulate_t(P_card=P_card, CaMorR=CaMorR, DiMorR=1, P_dig=P_dig, RR_T_car=0.54, RR_T_dig=0.90, horizon=20)
```
 
```{r}
Det_CEA_L_3<-QalyCost(population_over_time, population_over_time_t)
Det_CEA_L_3
```

```{r}
OWSADAT[3,]<-c("DiMorR", Det_CEA_H_3$ICER[2], Det_CEA_L_3$ICER[2])
OWSADAT
```

# 4. Probability of developing Chagas Digestive disease (P_dig)
```{r}
P_card<-BestVariab[1]
CaMorR<-BestVariab[2]
DiMorR<-BestVariab[3] # Cucunubá et al. Parasites&Vectors 2016
P_card_t<-BestVariab[1]*0.54
P_dig<-BestVariab[4]
P_dig_t<-BestVariab[4]*0.90
```
## High value
### Simulating non-treatment arm
```{r}
population_over_time<-Simulate(P_card=P_card, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=0.015, horizon=20)
```

### Simulating the treatment arm

```{r}
population_over_time_t<-Simulate_t(P_card=P_card, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=0.015, RR_T_car=0.54, RR_T_dig=0.90, horizon=20)
```

# Calculate Qalys and costs 

```{r}
Det_CEA_H_4<-QalyCost(population_over_time, population_over_time_t)
Det_CEA_H_4
```
## low value
```{r}
population_over_time<-Simulate(P_card=P_card, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=0.01, horizon=20)
```

```{r}
population_over_time_t<-Simulate_t(P_card=P_card, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=0.01, RR_T_car=0.49, RR_T_dig=0.88, horizon=20)
```
 
```{r}
Det_CEA_L_4<-QalyCost(population_over_time, population_over_time_t)
Det_CEA_L_4
```

```{r}
OWSADAT[4,]<-c("P_dig", Det_CEA_H_4$ICER[2], Det_CEA_L_4$ICER[2])
OWSADAT
```

# 5. Relative Risk reduction of the risk progresion to Cardiac Chagas disease
```{r}
P_card<-BestVariab[1]
CaMorR<-BestVariab[2]
DiMorR<-BestVariab[3] # Cucunubá et al. Parasites&Vectors 2016
P_dig<-BestVariab[4]
```
## High value
### Simulating non-treatment arm
```{r}
population_over_time<-Simulate(P_card=P_card, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=P_dig, horizon=20)
```

### Simulating the treatment arm

```{r}
population_over_time_t<-Simulate_t(P_card=P_card, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=P_dig, RR_T_car=1.18, RR_T_dig=0.9, horizon=20)
```

# Calculate Qalys and costs 

```{r}
Det_CEA_H_5<-QalyCost(population_over_time, population_over_time_t)
Det_CEA_H_5
```
## low value
```{r}
population_over_time<-Simulate(P_card=P_card, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=P_dig, horizon=20)
```

```{r}
population_over_time_t<-Simulate_t(P_card=P_card, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=P_dig, RR_T_car=0.25, RR_T_dig=0.9, horizon=20)
```
 
```{r}
Det_CEA_L_5<-QalyCost(population_over_time, population_over_time_t)
Det_CEA_L_5
```

```{r}
OWSADAT[5,]<-c("RR_T_car", Det_CEA_H_5$ICER[2], Det_CEA_L_5$ICER[2])
OWSADAT
```

# 6. Relative Risk reduction of the risk progresion to Digestive Chagas disease
```{r}
P_card<-BestVariab[1]
CaMorR<-BestVariab[2]
DiMorR<-BestVariab[3] # Cucunubá et al. Parasites&Vectors 2016
P_dig<-BestVariab[4]
```
## High value
### Simulating non-treatment arm
```{r}
population_over_time<-Simulate(P_card=P_card, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=P_dig, horizon=20)
```

### Simulating the treatment arm

```{r}
population_over_time_t<-Simulate_t(P_card=P_card, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=P_dig, RR_T_car=0.54, RR_T_dig=1.37, horizon=20)
```

# Calculate Qalys and costs 

```{r}
Det_CEA_H_6<-QalyCost(population_over_time, population_over_time_t)
Det_CEA_H_6
```
## low value
```{r}
population_over_time<-Simulate(P_card=P_card, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=P_dig, horizon=20)
```

```{r}
population_over_time_t<-Simulate_t(P_card=P_card, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=P_dig, RR_T_car=0.54, RR_T_dig=0.6, horizon=20)
```
 
```{r}
Det_CEA_L_6<-QalyCost(population_over_time, population_over_time_t)
Det_CEA_L_6
```
```{r}
OWSADAT[6,]<-c("RR_T_dig", Det_CEA_H_6$ICER[2], Det_CEA_L_6$ICER[2])
```


```{r}

OWSADAT <- OWSADAT %>%
  mutate(Parameter = case_when(
    Parameter == "P_card"     ~ "Prob cardiac disease",
    Parameter == "CaMorR"     ~ "Cardiac mortality rate",
    Parameter == "DiMorR"     ~ "Digestive mortality rate",
    Parameter == "P_dig"      ~ "Prob digestive disease",
    Parameter == "RR_T_car"   ~ "Risk reduction cardiac disease",
    Parameter == "RR_T_dig"   ~ "Risk reduction digestive disease",
    TRUE                      ~ Parameter  # keep others unchanged
  ))
OWSADAT
```

```{r}

base_icer <- -61294.07
WTP<-33895

# Prepare data for plotting
tornado_df <- OWSADAT %>%
  mutate(
    low = as.numeric(pmin(ICER_low, ICER_high)),
    high = as.numeric(pmax(ICER_low, ICER_high))
  ) %>%
  arrange(abs(high - low)) %>%
  mutate(Parameter = factor(Parameter, levels = Parameter))  # preserve order

# Plot
fig2<-ggplot(tornado_df) +
  geom_segment(aes(x = Parameter, xend = Parameter,
                   y = low, yend = high, color = Parameter),
               linewidth = 6) +
  geom_hline(yintercept = base_icer, linetype = "dashed") +
  geom_hline(yintercept = WTP, linetype = "solid") +
  coord_flip() +
  labs(
    title = "Tornado Plot of ICER",
    x = "Parameter",
    y = "ICER (2025€ per QALY)"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
fig2
```
```{r}
#pdf("OWSA.pdf", width=7, height=5)
fig2
#dev.off()
```

```{r}
# ---- 1) Build a tidy one-way dataset with ΔC, ΔQ, ICER for each bound ----
# Assumes QalyCost() returns columns named DeltaCost, DeltaQALY, ICER;
# if your names differ, change them below.
# Coerce matrix -> data.frame and keep strings as strings
OWSADAT <- as.data.frame(OWSADAT, stringsAsFactors = FALSE)

# Clean non-numeric placeholders and convert ICER columns to numeric
to_numeric_icers <- function(x) {
  x[ x %in% c("", "NA", "NaN", "Inf", "-Inf", "Dominated") ] <- NA
  suppressWarnings(as.numeric(x))
}

OWSADAT$ICER_high <- to_numeric_icers(OWSADAT$ICER_high)
OWSADAT$ICER_low  <- to_numeric_icers(OWSADAT$ICER_low)

# Ensure Parameter is plain character (or factor later if you like)
OWSADAT$Parameter <- as.character(OWSADAT$Parameter)

# (Optional sanity check)
str(OWSADAT)



mk_row <- function(param, bound, res){
  tibble::tibble(
    Parameter = param,
    bound = bound,
    dC = as.numeric(res$ACosts[2]),
    dQ = as.numeric(res$AQALYs[2]),
    ICER = as.numeric(res$ICER[2]),
    dominated = dC > 0 & dQ < 0
  )
}

owsa_long <- dplyr::bind_rows(
  mk_row("P_card",  "high", Det_CEA_H_1),
  mk_row("P_card",  "low",  Det_CEA_L_1),
  mk_row("CaMorR",  "high", Det_CEA_H_2),
  mk_row("CaMorR",  "low",  Det_CEA_L_2),
  mk_row("DiMorR",  "high", Det_CEA_H_3),
  mk_row("DiMorR",  "low",  Det_CEA_L_3),
  mk_row("P_dig",   "high", Det_CEA_H_4),
  mk_row("P_dig",   "low",  Det_CEA_L_4),
  mk_row("RR_T_car","high", Det_CEA_H_5),
  mk_row("RR_T_car","low",  Det_CEA_L_5),
  mk_row("RR_T_dig","high", Det_CEA_H_6),
  mk_row("RR_T_dig","low",  Det_CEA_L_6)
) |>
  dplyr::mutate(
    Parameter = dplyr::case_when(
      Parameter == "P_card"   ~ "Prob cardiac disease",
      Parameter == "CaMorR"   ~ "Cardiac mortality rate",
      Parameter == "DiMorR"   ~ "Digestive mortality rate",
      Parameter == "P_dig"    ~ "Prob digestive disease",
      Parameter == "RR_T_car" ~ "Risk reduction cardiac disease",
      Parameter == "RR_T_dig" ~ "Risk reduction digestive disease",
      TRUE ~ Parameter
    )
  )

# ---- 2) Compute INMB and make the tornado ----
lambda <- WTP  # you already set WTP <- 33895
tornado_inmb <- owsa_long %>%
  mutate(INMB = lambda * dQ - dC) %>%
  dplyr::select(Parameter, bound, INMB) %>%                       # keep only what's needed
  tidyr::pivot_wider(
    id_cols   = Parameter,                                  # <-- key fix
    names_from  = bound,
    values_from = INMB
  ) %>%
  mutate(
    lo    = pmin(low, high, na.rm = TRUE),
    hi    = pmax(low, high, na.rm = TRUE),
    width = abs(hi - lo)
  ) %>%
  arrange(width) %>%
  mutate(Parameter = factor(Parameter, levels = Parameter))

fig_2<-ggplot(tornado_inmb) +
  geom_segment(aes(y = Parameter, yend = Parameter, x = lo, xend = hi, color=Parameter), linewidth = 6) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  labs(
    title = "         One-way sensitivity analysis of 
    incremental net monetary benefit (INMB)",
    x = paste0("INMB (€) at lambda = €", format(lambda, big.mark=",")),
    y = NULL
  ) +
  theme_minimal()+
  theme(legend.position="none")
fig_2
```

```{r}
pdf("OWSA.pdf", width=7, height=5)
fig_2
dev.off()
```