---
title: "BZN CEA"
author: "Philip Wikman"
date: "2025-01-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Paquetes necesarios
library(dplyr)
library(ggplot2)
library(MASS)
library(tidyr)

source("invbeta.R")
source("generate_rr_lognormal.R")
```


```{r}
set.seed(123)

reps<-100000
reps_SMSE<-vector(mode="numeric", length=length(reps))
  

P_card_v<-invbeta(n=reps)
CaMorR_v<-generate_rr_lognormal(1,10,n=reps)
DiMorR_v<-generate_rr_lognormal(1,4,n=reps)
P_dig_v<-invbeta(mu=0.011, low=0.001, high=0.11, n=reps)

for (i in 1:reps){
cat(sprintf("\rProgress: %d%% | Iteration %d of %d", round(i / reps * 100), i, reps))
flush.console()

# Definir parámetros del modelo
horizon <- 10            # Horizonte temporal (en años)
cycle_length <- 1        # Longitud de cada ciclo (en años)
discount_rate <- 0.03    # Tasa de descuento anual

# Estados de salud
states <- c("Chronic_Asymptomatic", "Cardiac", "Digestive", "Death")
grupos_edad<-c("15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", "60-64", "65-69")
grupos_sexo<-c("Hombre", "Mujer")
deaths<-c(4,2,4,5,6,3,0,7,5,9)
years<-c(2009:2018)

P_card<-P_card_v[i]
CaMorR<-CaMorR_v[i]
DiMorR<-DiMorR_v[i] #(1.5-2.91) # Cucunubá et al. Parasites&Vectors 2016
#P_card_t<-0.019*0.49
P_dig<-P_dig_v[i]
#P_dig_t<-0.011*0.88

P_mort_m<-c(0.00015, 0.00037, 0.00044, 0.00054, 0.00077, 0.00095, 0.00161, 0.00289, 0.00543, 0.00893, 0.01401)
P_mort_W<-c(0.00014, 0.00016, 0.00015, 0.00023, 0.00037, 0.00062, 0.00096, 0.00158, 0.00273, 0.00429, 0.00648)

# Probabilidades de transición para el brazo SIN intervención
transition_matrices <- list(
  "Hombre" = list(
    "15-19" = matrix(c(1-P_card-P_dig-P_mort_m[1], P_card, P_dig, P_mort_m[1],  
                       0.00, 1-P_dig-P_mort_m[1]*CaMorR, P_dig, P_mort_m[1]*CaMorR,  
                       0.00, 0.00, 1-P_mort_m[1], P_mort_m[1],  
                       0.00, 0.00, 0.00, 1.00),  
                   byrow = TRUE, nrow = 4),

    "20-24" = matrix(c(1-P_card-P_dig-P_mort_m[2], P_card, P_dig, P_mort_m[2],  
                       0.00, 1-P_dig-P_mort_m[2]*CaMorR, P_dig, P_mort_m[1]*CaMorR, 
                       0.00, 0.00, 1-P_mort_m[2], P_mort_m[2],  
                       0.00, 0.00, 0.00, 1.00),  
                   byrow = TRUE, nrow = 4),

    "25-29" = matrix(c(1-P_card-P_dig-P_mort_m[3], P_card, P_dig, P_mort_m[3],  
                       0.00, 1-P_dig-P_mort_m[3]*CaMorR, P_dig, P_mort_m[1]*CaMorR, 
                       0.00, 0.00, 1-P_mort_m[3], P_mort_m[3],  
                       0.00, 0.00, 0.00, 1.00),  
                   byrow = TRUE, nrow = 4),

    "30-34" = matrix(c(1-P_card-P_dig-P_mort_m[4], P_card, P_dig, P_mort_m[4],  
                       0.00, 1-P_dig-P_mort_m[4]*CaMorR, P_dig, P_mort_m[1]*CaMorR,  
                       0.00, 0.00, 1-P_mort_m[4], P_mort_m[4],  
                       0.00, 0.00, 0.00, 1.00),  
                   byrow = TRUE, nrow = 4), 
    
    "35-39" = matrix(c(1-P_card-P_dig-P_mort_m[5], P_card, P_dig, P_mort_m[5],  
                       0.00, 1-P_dig-P_mort_m[5]*CaMorR, P_dig, P_mort_m[1]*CaMorR, 
                       0.00, 0.00, 1-P_mort_m[5], P_mort_m[5],  
                       0.00, 0.00, 0.00, 1.00),  
                   byrow = TRUE, nrow = 4),

    "40-44" = matrix(c(1-P_card-P_dig-P_mort_m[6], P_card, P_dig, P_mort_m[6],  
                       0.00, 1-P_dig-P_mort_m[6]*CaMorR, P_dig, P_mort_m[1]*CaMorR,
                       0.00, 0.00, 1-P_mort_m[6], P_mort_m[6],  
                       0.00, 0.00, 0.00, 1.00),  
                    byrow = TRUE, nrow = 4),

    "45-49" = matrix(c(1-P_card-P_dig-P_mort_m[7], P_card, P_dig, P_mort_m[7],  
                       0.00, 1-P_dig-P_mort_m[7]*CaMorR, P_dig, P_mort_m[1]*CaMorR, 
                       0.00, 0.00, 1-P_mort_m[7], P_mort_m[7],  
                       0.00, 0.00, 0.00, 1.00),  
                    byrow = TRUE, nrow = 4),

    "50-54" = matrix(c(1-P_card-P_dig-P_mort_m[8], P_card, P_dig, P_mort_m[8],  
                       0.00, 1-P_dig-P_mort_m[8]*CaMorR, P_dig, P_mort_m[1]*CaMorR,  
                       0.00, 0.00, 1-P_mort_m[8], P_mort_m[8],  
                       0.00, 0.00, 0.00, 1.00), 
                   byrow = TRUE, nrow = 4),
    
    "55-59" = matrix(c(1-P_card-P_dig-P_mort_m[9], P_card, P_dig, P_mort_m[9],  
                       0.00, 1-P_dig-P_mort_m[9]*CaMorR, P_dig, P_mort_m[1]*CaMorR,  
                       0.00, 0.00, 1-P_mort_m[9], P_mort_m[9],  
                       0.00, 0.00, 0.00, 1.00),
                   byrow = TRUE, nrow = 4),
    
    "60-64" = matrix(c(1-P_card-P_dig-P_mort_m[10], P_card, P_dig, P_mort_m[10],  
                       0.00, 1-P_dig-P_mort_m[10]*CaMorR, P_dig, P_mort_m[1]*CaMorR, 
                       0.00, 0.00, 1-P_mort_m[10], P_mort_m[10],  
                       0.00, 0.00, 0.00, 1.00), 
                   byrow = TRUE, nrow = 4),
    
    "65-69" = matrix(c(1-P_card-P_dig-P_mort_m[11], P_card, P_dig, P_mort_m[11],  
                       0.00, 1-P_dig-P_mort_m[11]*CaMorR, P_dig, P_mort_m[1]*CaMorR,  
                       0.00, 0.00, 1-P_mort_m[11], P_mort_m[11],  
                       0.00, 0.00, 0.00, 1.00),  
                   byrow = TRUE, nrow = 4)
    
  ),
  "Mujer" = list(
    "15-19" = matrix(c(1-P_card-P_dig-P_mort_W[1], P_card, P_dig, P_mort_W[1],  
                       0.00, 1-P_dig-P_mort_W[1]*CaMorR, P_dig, P_mort_m[1]*CaMorR, 
                       0.00, 0.00, 1-P_mort_W[1], P_mort_W[1],  
                       0.00, 0.00, 0.00, 1.00),  
                   byrow = TRUE, nrow = 4),

    "20-24" = matrix(c(1-P_card-P_dig-P_mort_W[2], P_card, P_dig, P_mort_W[2],  
                       0.00, 1-P_dig-P_mort_W[2]*CaMorR, P_dig, P_mort_m[1]*CaMorR, 
                       0.00, 0.00, 1-P_mort_W[2], P_mort_W[2],  
                       0.00, 0.00, 0.00, 1.00),  
                    byrow = TRUE, nrow = 4),

    "25-29" = matrix(c(1-P_card-P_dig-P_mort_W[3], P_card, P_dig, P_mort_W[3],  
                       0.00, 1-P_dig-P_mort_W[3]*CaMorR, P_dig, P_mort_m[1]*CaMorR, 
                       0.00, 0.00, 1-P_mort_W[3], P_mort_W[3],  
                       0.00, 0.00, 0.00, 1.00),  
                    byrow = TRUE, nrow = 4),

    "30-34" = matrix(c(1-P_card-P_dig-P_mort_W[4], P_card, P_dig, P_mort_W[4],  
                       0.00, 1-P_dig-P_mort_W[4]*CaMorR, P_dig, P_mort_m[1]*CaMorR,  
                       0.00, 0.00, 1-P_mort_W[4], P_mort_W[4],  
                       0.00, 0.00, 0.00, 1.00),  
                   byrow = TRUE, nrow = 4),
    
    "35-39" = matrix(c(1-P_card-P_dig-P_mort_W[5], P_card, P_dig, P_mort_W[5],  
                       0.00, 1-P_dig-P_mort_W[5]*CaMorR, P_dig, P_mort_m[1]*CaMorR,  
                       0.00, 0.00, 1-P_mort_W[5], P_mort_W[5],  
                       0.00, 0.00, 0.00, 1.00),  
                   byrow = TRUE, nrow = 4),

    "40-44" = matrix(c(1-P_card-P_dig-P_mort_W[6], P_card, P_dig, P_mort_W[6],  
                       0.00, 1-P_dig-P_mort_W[6]*CaMorR, P_dig, P_mort_m[1]*CaMorR,  
                       0.00, 0.00, 1-P_mort_W[6], P_mort_W[6],  
                       0.00, 0.00, 0.00, 1.00),  
                    byrow = TRUE, nrow = 4),

    "45-49" = matrix(c(1-P_card-P_dig-P_mort_W[7], P_card, P_dig, P_mort_W[7],  
                       0.00, 1-P_dig-P_mort_W[7]*CaMorR, P_dig, P_mort_m[1]*CaMorR,  
                       0.00, 0.00, 1-P_mort_W[7], P_mort_W[7],  
                       0.00, 0.00, 0.00, 1.00),  
                    byrow = TRUE, nrow = 4),

    "50-54" = matrix(c(1-P_card-P_dig-P_mort_W[8], P_card, P_dig, P_mort_W[8],  
                       0.00, 1-P_dig-P_mort_W[8]*CaMorR, P_dig, P_mort_m[1]*CaMorR,  
                       0.00, 0.00, 1-P_mort_W[8], P_mort_W[8],  
                       0.00, 0.00, 0.00, 1.00), 
                   byrow = TRUE, nrow = 4),
    
    "55-59" = matrix(c(1-P_card-P_dig-P_mort_W[9], P_card, P_dig, P_mort_W[9],  
                       0.00, 1-P_dig-P_mort_W[9]*CaMorR, P_dig, P_mort_m[1]*CaMorR,
                       0.00, 0.00, 1-P_mort_W[9], P_mort_W[9],
                       0.00, 0.00, 0.00, 1.00),
                   byrow = TRUE, nrow = 4),
    
    "60-64" = matrix(c(1-P_card-P_dig-P_mort_W[10], P_card, P_dig, P_mort_W[10],  
                       0.00, 1-P_dig-P_mort_W[10]*CaMorR, P_dig, P_mort_m[1]*CaMorR,  
                       0.00, 0.00, 1-P_mort_W[10], P_mort_W[10], 
                       0.00, 0.00, 0.00, 1.00),
                   byrow = TRUE, nrow = 4),
    
    "65-69" = matrix(c(1-P_card-P_dig-P_mort_W[11], P_card, P_dig, P_mort_W[11],  
                       0.00, 1-P_dig-P_mort_W[11]*CaMorR, P_dig, P_mort_m[1]*CaMorR,  
                       0.00, 0.00, 1-P_mort_W[11], P_mort_W[11], 
                       0.00, 0.00, 0.00, 1.00),
                   byrow = TRUE, nrow = 4)
  )
)


# Initial population distribution (Distribución según INE (personas de sudamérica), casos según Navarro et al 2022)
population <- list()
Chr_Asym_H<-c(1624, 2767, 3867, 4136, 3554, 3166, 2292, 1496, 933, 552, 307)
names(Chr_Asym_H)<-grupos_edad
  for (age  in grupos_edad) {
    population[["Hombre"]][[age]] <- c(Chronic_Asymptomatic = Chr_Asym_H[age], 
                                   Cardiac = 0, 
                                   Digestive = 0, 
                                   Death = 0)
  }

Chr_Asym_M<-c(1355, 2571, 4170, 4378, 4053, 3861, 3091, 2521, 1939, 1369, 1014)
names(Chr_Asym_M)<-grupos_edad
  for (age  in grupos_edad) {
    population[["Mujer"]][[age]] <- c(Chronic_Asymptomatic = Chr_Asym_M[age], 
                                   Cardiac = 0, 
                                   Digestive = 0, 
                                   Death = 0)
  }

# Simulation loop

# Initialize storage for population evolution
population_over_time <- list()
deaths_chagas_over_time <- list()

prop_moving <- 0.2  # 20% of the population moves each year as the year groups are of 5 years
for (t in 1:horizon) {
  
  new_population <- list()
  deaths_chagas <- list()
  
  for (sex in grupos_sexo) {
    new_population[[sex]] <- list()
    deaths_chagas[[sex]] <- list()
    
    for (age in grupos_edad) {
      new_population[[sex]][[age]] <- rep(0, length(states)) # Initialize empty state vector
      deaths_chagas[[sex]][[age]] <- 0 # Initialize Chagas deaths
    }
  }
  
  for (sex in grupos_sexo) {
    for (age in grupos_edad) {
      # Get the transition matrix
      trans_mat <- transition_matrices[[sex]][[age]]
      
      # Current population in this (sex, age) group
      current_pop <- unlist(population[[sex]][[age]])
      
      # Compute next year's population distribution
      new_pop <- as.numeric(current_pop %*% trans_mat)
      
      # Extract deaths (assuming "Death" is a known index in states)
      death_index <- which(states == "Death")
      cardiac_chagas_index <- which(states == "Cardiac")

      # Total deaths from the "Cardiac Chagas Disease" state
      deaths_from_cardiac_chagas <- current_pop[cardiac_chagas_index] * trans_mat[cardiac_chagas_index, death_index]

      # Assume x% of these deaths are due to Chagas cardiac disease
      deaths_chagas[[sex]][[age]] <- (1-(1/CaMorR)) * deaths_from_cardiac_chagas

      # Remove deaths from the population update
      #new_pop[death_index] <- 0
      
      # Move individuals to the next age group if possible
      next_age_group <- switch(age,
                               "15-19" = "20-24",
                               "20-24" = "25-29",
                               "25-29" = "30-34",
                               "30-34" = "35-39",
                               "35-39" = "40-44",
                               "40-44" = "45-49",
                               "45-49" = "50-54",
                               "50-54" = "55-59",
                               "55-59" = "60-64",
                               "60-64" = "65-69",
                               "65-69" = "65-69",
                               age  # If the age group is not in the switch statement, keep it
      )

      # Store updated population
      if (next_age_group != age) {
        if (is.null(new_population[[sex]][[next_age_group]])) {
          new_population[[sex]][[next_age_group]] <- new_pop
        } else {
          new_population[[sex]][[next_age_group]] <- new_population[[sex]][[next_age_group]] + prop_moving *new_pop
          new_population[[sex]][[age]] <- (1 - prop_moving) * new_pop
        }
      } else {
        new_population[[sex]][[age]] <- new_pop
      }
    }
  }
  
  # Save population state at this time step
  population_over_time[[t]] <- population
  deaths_chagas_over_time[[t]] <- deaths_chagas
  
  # 1. Calculate total deaths in this cycle (from all ages and sexes)
total_deaths <- 0
for (sex in grupos_sexo) {
  for (age in grupos_edad) {
    current_pop <- unlist(population[[sex]][[age]])
    trans_mat <- transition_matrices[[sex]][[age]]
    death_index <- which(states == "Death")
    
    deaths_from_all_states <- sum(current_pop * trans_mat[, death_index])
    total_deaths <- total_deaths + deaths_from_all_states
  }
}

# 2. Inject new individuals into "15-19" group (in a chosen state, e.g., "Chronic_Asymptomatic")
start_state_index <- which(states == "Chronic_Asymptomatic")

# Distribute equally across sex (you can also change this logic)
for (sex in grupos_sexo) {
  new_population[[sex]][["15-19"]][start_state_index] <- 
    new_population[[sex]][["15-19"]][start_state_index] + total_deaths / length(grupos_sexo)
}

  # Update population for the next cycle
  population <- new_population
}


df <- data.frame()

for (t in 1:horizon) {
  for (sex in grupos_sexo) {
    for (age in grupos_edad) {
      state_values <- population_over_time[[t]][[sex]][[age]]
      df <- rbind(df, data.frame(
        Year = t,
        Sex = sex,
        Age_Group = age,
        Chronic_Asymptomatic = state_values[1],
        Cardiac = state_values[2],
        Digestive = state_values[3],
        Death = state_values[4]
      ))
    }
  }
}

deaths_chagas_df <- do.call(rbind, lapply(seq_along(deaths_chagas_over_time), function(t) {
  data <- deaths_chagas_over_time[[t]]
  do.call(rbind, lapply(names(data), function(sex) {
    do.call(rbind, lapply(names(data[[sex]]), function(age) {
      data.frame(
        year = t,
        sex = sex,
        age_group = age,
        deaths = data[[sex]][[age]]
      )
    }))
  }))
}))

deaths_chagas_disease <- deaths_chagas_df%>%group_by(year)%>%summarise(count=sum(deaths, na.rm=TRUE))%>%
  mutate(year=2009:2018)
deaths_chagas_disease2<-cbind(deaths_chagas_disease, deaths)

MSE<-(deaths_chagas_disease2$deaths-deaths_chagas_disease2$count)^2
MSE
SMSE<-sum(MSE)/length(MSE)
SMSE

reps_SMSE[i]<-SMSE

}

reps_SMSE
```
```{r}
variab_df<-tibble(P_card_v, CaMorR_v, DiMorR_v, P_dig_v)
variab_df
```


```{r}
which.min(reps_SMSE)
```


