---
title: "BZN OWA"
author: "Philip Wikman"
date: "2025-01-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Paquetes necesarios
library(dplyr)
library(ggplot2)
library(MASS)
library(tidyr)
library(ggplot2)
source("calculate_qalys_costs.R")
source("Simulate.R")
source("Simulate_t.R")
source("QalyCost.R")
```


```{r}
# Definir parámetros del modelo
cycle_length <- 1        # Longitud de cada ciclo (en años)
discount_rate <- 0.03    # Tasa de descuento anual
BestVariab<-as.numeric(as.vector(readRDS("BestVariab_100000.RDS")))
grupos_sexo<-c("Hombre", "Mujer")
states <- c("Chronic_Asymptomatic", "Cardiac", "Digestive", "Death")
grupos_edad<-c("15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", "60-64", "65-69")
# Estados de salud

P_card<-BestVariab[1]
CaMorR<-BestVariab[2]
DiMorR<-BestVariab[3] # Cucunubá et al. Parasites&Vectors 2016
P_card_t<-BestVariab[1]*0.54
P_dig<-BestVariab[4]
P_dig_t<-BestVariab[4]*0.90

P_mort_m<-c(0.00015, 0.00037, 0.00044, 0.00054, 0.00077, 0.00095, 0.00161, 0.00289, 0.00543, 0.00893, 0.01401)
P_mort_W<-c(0.00014, 0.00016, 0.00015, 0.00023, 0.00037, 0.00062, 0.00096, 0.00158, 0.00273, 0.00429, 0.00648)

qaly_weights <- c(
  Chronic_Asymptomatic = 0.9625,
  Cardiac = 0.7171,
  Digestive = 0.80,
  Death = 0
)

costs <- c(
  Chronic_Asymptomatic = 380.26,
  Cardiac = 11592.27,
  Digestive = 554.56,
  Death = 0
)
discount_rate <- 0.03  # 3% discount rate

OWSADAT<-data.frame(matrix(NA, nrow=6, ncol=3))
colnames(OWSADAT)<-c("Parameter", "ICER_high", "ICER_low")
```

# 1. Probability of developing Chagas sympthomatic cardiomyopathy (P_card)

## High value
### Simulating non-treatment arm
```{r}
population_over_time<-Simulate(P_card=0.03, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=P_dig, horizon=20)
```

### Simulating the treatment arm

```{r}
population_over_time_t<-Simulate_t(P_card=0.03, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=P_dig, RR_T_car=0.54, RR_T_dig=0.90, horizon=20)
```

# Calculate Qalys and costs 

```{r}
Det_CEA_H<-QalyCost(population_over_time, population_over_time_t)


Det_CEA_H
```
## low value
```{r}
population_over_time<-Simulate(P_card=0.01, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=P_dig, horizon=20)
```

```{r}
population_over_time_t<-Simulate_t(P_card=0.01, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=P_dig, RR_T_car=0.54, RR_T_dig=0.90, horizon=20)
```
 
```{r}
Det_CEA_L<-QalyCost(population_over_time, population_over_time_t)
Det_CEA_L
```

```{r}
OWSADAT[1,]<-c("P_card", Det_CEA_H$ICER[2], Det_CEA_L$ICER[2])
OWSADAT
```

# 2. Chagas Cardiac Disease Mortality  (CaMorR)
```{r}
P_card<-BestVariab[1]
CaMorR<-BestVariab[2]
DiMorR<-BestVariab[3] 
P_card_t<-BestVariab[1]*0.54
P_dig<-BestVariab[4]
P_dig_t<-BestVariab[4]*0.90
```
## High value
### Simulating non-treatment arm
```{r}
population_over_time<-Simulate(P_card=P_card, CaMorR=5, DiMorR=DiMorR, P_dig=P_dig, horizon=20)
```

### Simulating the treatment arm

```{r}
population_over_time_t<-Simulate_t(P_card=P_card, CaMorR=5, DiMorR=DiMorR, P_dig=P_dig, RR_T_car=0.54, RR_T_dig=0.90, horizon=20)
```

# Calculate Qalys and costs 

```{r}
Det_CEA_H<-QalyCost(population_over_time, population_over_time_t)
Det_CEA_H
```
## low value
```{r}
population_over_time<-Simulate(P_card=P_card, CaMorR=1.1, DiMorR=DiMorR, P_dig=P_dig, horizon=20)
```

```{r}
population_over_time_t<-Simulate_t(P_card=P_card, CaMorR=1.1, DiMorR=DiMorR, P_dig=P_dig, RR_T_car=0.54, RR_T_dig=0.90, horizon=20)
```
 
```{r}
Det_CEA_L<-QalyCost(population_over_time, population_over_time_t)
Det_CEA_L
```

```{r}
OWSADAT[2,]<-c("CaMorR", Det_CEA_H$ICER[2], Det_CEA_L$ICER[2])
OWSADAT
```

# 3. Chagas Digestive disease Mortality  (DiMorR)
```{r}
P_card<-BestVariab[1]
CaMorR<-BestVariab[2]
DiMorR<-BestVariab[3] # Cucunubá et al. Parasites&Vectors 2016
P_card_t<-BestVariab[1]*0.54
P_dig<-BestVariab[4]
P_dig_t<-BestVariab[4]*0.90
```
## High value
### Simulating non-treatment arm
```{r}
population_over_time<-Simulate(P_card=P_card, CaMorR=CaMorR, DiMorR=2.5, P_dig=P_dig, horizon=20)
```

### Simulating the treatment arm

```{r}
population_over_time_t<-Simulate_t(P_card=P_card, CaMorR=CaMorR, DiMorR=2.5, P_dig=P_dig, RR_T_car=0.54, RR_T_dig=0.90, horizon=20)
```

# Calculate Qalys and costs 

```{r}
Det_CEA_H<-QalyCost(population_over_time, population_over_time_t)
Det_CEA_H
```
## low value
```{r}
population_over_time<-Simulate(P_card=P_card, CaMorR=CaMorR, DiMorR=1, P_dig=P_dig, horizon=20)
```

```{r}
population_over_time_t<-Simulate_t(P_card=P_card, CaMorR=CaMorR, DiMorR=1, P_dig=P_dig, RR_T_car=0.54, RR_T_dig=0.90, horizon=20)
```
 
```{r}
Det_CEA_L<-QalyCost(population_over_time, population_over_time_t)
Det_CEA_L
```

```{r}
OWSADAT[3,]<-c("DiMorR", Det_CEA_H$ICER[2], Det_CEA_L$ICER[2])
OWSADAT
```

# 4. Probability of developing Chagas Digestive disease (P_dig)
```{r}
P_card<-BestVariab[1]
CaMorR<-BestVariab[2]
DiMorR<-BestVariab[3] # Cucunubá et al. Parasites&Vectors 2016
P_card_t<-BestVariab[1]*0.54
P_dig<-BestVariab[4]
P_dig_t<-BestVariab[4]*0.90
```
## High value
### Simulating non-treatment arm
```{r}
population_over_time<-Simulate(P_card=P_card, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=0.015, horizon=20)
```

### Simulating the treatment arm

```{r}
population_over_time_t<-Simulate_t(P_card=P_card, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=0.015, RR_T_car=0.54, RR_T_dig=0.90, horizon=20)
```

# Calculate Qalys and costs 

```{r}
Det_CEA_H<-QalyCost(population_over_time, population_over_time_t)
Det_CEA_H
```
## low value
```{r}
population_over_time<-Simulate(P_card=P_card, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=0.01, horizon=20)
```

```{r}
population_over_time_t<-Simulate_t(P_card=P_card, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=0.01, RR_T_car=0.49, RR_T_dig=0.88, horizon=20)
```
 
```{r}
Det_CEA_L<-QalyCost(population_over_time, population_over_time_t)
Det_CEA_L
```

```{r}
OWSADAT[4,]<-c("P_dig", Det_CEA_H$ICER[2], Det_CEA_L$ICER[2])
OWSADAT
```

# 5. Relative Risk reduction of the risk progresion to Cardiac Chagas disease
```{r}
P_card<-BestVariab[1]
CaMorR<-BestVariab[2]
DiMorR<-BestVariab[3] # Cucunubá et al. Parasites&Vectors 2016
P_dig<-BestVariab[4]
```
## High value
### Simulating non-treatment arm
```{r}
population_over_time<-Simulate(P_card=P_card, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=P_dig, horizon=20)
```

### Simulating the treatment arm

```{r}
population_over_time_t<-Simulate_t(P_card=P_card, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=P_dig, RR_T_car=1.18, RR_T_dig=0.9, horizon=20)
```

# Calculate Qalys and costs 

```{r}
Det_CEA_H<-QalyCost(population_over_time, population_over_time_t)
Det_CEA_H
```
## low value
```{r}
population_over_time<-Simulate(P_card=P_card, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=P_dig, horizon=20)
```

```{r}
population_over_time_t<-Simulate_t(P_card=P_card, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=P_dig, RR_T_car=0.25, RR_T_dig=0.9, horizon=20)
```
 
```{r}
Det_CEA_L<-QalyCost(population_over_time, population_over_time_t)
Det_CEA_L
```

```{r}
OWSADAT[5,]<-c("RR_T_car", Det_CEA_H$ICER[2], Det_CEA_L$ICER[2])
OWSADAT
```

# 6. Relative Risk reduction of the risk progresion to Digestive Chagas disease
```{r}
P_card<-BestVariab[1]
CaMorR<-BestVariab[2]
DiMorR<-BestVariab[3] # Cucunubá et al. Parasites&Vectors 2016
P_dig<-BestVariab[4]
```
## High value
### Simulating non-treatment arm
```{r}
population_over_time<-Simulate(P_card=P_card, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=P_dig, horizon=20)
```

### Simulating the treatment arm

```{r}
population_over_time_t<-Simulate_t(P_card=P_card, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=P_dig, RR_T_car=0.54, RR_T_dig=1.37, horizon=20)
```

# Calculate Qalys and costs 

```{r}
Det_CEA_H<-QalyCost(population_over_time, population_over_time_t)
Det_CEA_H
```
## low value
```{r}
population_over_time<-Simulate(P_card=P_card, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=P_dig, horizon=20)
```

```{r}
population_over_time_t<-Simulate_t(P_card=P_card, CaMorR=CaMorR, DiMorR=DiMorR, P_dig=P_dig, RR_T_car=0.54, RR_T_dig=0.6, horizon=20)
```
 
```{r}
Det_CEA_L<-QalyCost(population_over_time, population_over_time_t)
Det_CEA_L
```

```{r}
OWSADAT[6,]<-c("RR_T_dig", Det_CEA_H$ICER[2], Det_CEA_L$ICER[2])
OWSADAT <- OWSADAT %>%
  mutate(Parameter = case_when(
    Parameter == "P_card"     ~ "Prob cardiac disease",
    Parameter == "CaMorR"     ~ "Cardiac mortality rate",
    Parameter == "DiMorR"     ~ "Digestive mortality rate",
    Parameter == "P_dig"      ~ "Prob digestive disease",
    Parameter == "RR_T_car"   ~ "Risk reduction cardiac disease",
    Parameter == "RR_T_dig"   ~ "Risk reduction digestive disease",
    TRUE                      ~ Parameter  # keep others unchanged
  ))
OWSADAT
```

```{r}

base_icer <- -61294.07
WTP<-33895

# Prepare data for plotting
tornado_df <- OWSADAT %>%
  mutate(
    low = as.numeric(pmin(ICER_low, ICER_high)),
    high = as.numeric(pmax(ICER_low, ICER_high))
  ) %>%
  arrange(abs(high - low)) %>%
  mutate(Parameter = factor(Parameter, levels = Parameter))  # preserve order

# Plot
ggplot(tornado_df) +
  geom_segment(aes(x = Parameter, xend = Parameter,
                   y = low, yend = high, color = Parameter),
               linewidth = 6) +
  geom_hline(yintercept = base_icer, linetype = "dashed") +
  geom_hline(yintercept = WTP, linetype = "solid") +
  coord_flip() +
  labs(
    title = "Tornado Plot of ICER",
    x = "Parameter",
    y = "ICER (2023€ per QALY)"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```